<!doctype html>
<html lang="en">
  <head>
    <title>Kein Stress mit Pollen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/style.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="css/leaflet.ie.css" />
    <![endif]-->
    <script src="js/leaflet.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <script>
    
      //Depending on the level of allergic potential, the base Radius is either 15 (very strong), 10 (strong), 5 (medium) or 2 (low)
      var TREE_SPECS = {
        Betula:   { name: "Birke", color: '#f03', baseRadius: 15 },
        Alnus:    { name: "Erle",  color: '#30f', baseRadius: 10 },
        Corylus:  { name: "Hasel", color: '#3f0', baseRadius: 10 },
        Fraxinus: { name: "Esche", color: '#cc3', baseRadius: 10 },
        Fagus:    { name: "Buche", color: '#3cf', baseRadius:  5 },
        Quercus:  { name: "Eiche", color: '#c3f', baseRadius:  5 },
        Salix:    { name: "Weide", color: '#efd', baseRadius:  2 }
      };


      var map = L.map('map').setView([47.367347, 8.5500025], 13);
      L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
        maxZoom: 18
      }).addTo(map);
      
      var drawTrees = function(trees) {
        for(var i=0; i < trees.length; i++) {
          var treeColor = TREE_SPECS[trees[i].Baumgattung].color
          L.circle([trees[i].lat, trees[i].lon], TREE_SPECS[trees[i].Baumgattung].baseRadius, {
            color:       treeColor,
            fillColor:   treeColor,
            fillOpacity: 0.5
          }).addTo(map);
        }
      };
      
      var handleResult = function() {
        console.log("LOADING");
        var t_start = new Date().getTime();
          
        var trees = JSON.parse(this.responseText).result;
        drawTrees(trees);
          
        console.log("DONE", new Date().getTime() - t_start);
      };
      
      //Here the magic happens:
      (function() {
        var xhr = new XMLHttpRequest();
        var treeNames = [];
        for(treeName in TREE_SPECS) { treeNames.push(treeName); };
        
        xhr.onload = handleResult;
        xhr.open('post', 'https://data.mingle.io/');
        xhr.send(JSON.stringify({expr: '[ tree | tree <- ch_zh_baumkataster, allergenic <- ' + JSON.stringify(treeNames) + ', tree.Baumgattung == allergenic ]'})); //'expr=' + encodeURIComponent('[ tree | tree <- ch_zh_baumkataster, allergenic <- ["Betula", "Alnus"], tree.Baumgattung == allergenic ]'));
      })();
      
    </script>
  </body>
</html>
